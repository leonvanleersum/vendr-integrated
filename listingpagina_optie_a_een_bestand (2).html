<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Objecten – Lokaal Opslaan (één bestand)</title>
  <meta name="description" content="Listingpagina die lokaal als .html werkt: laden vanaf feed-URL, JSON plakken of JSON-bestand uploaden, met fallbackdata." />
  <style>
    /* --- Zelfstandige, compacte CSS (geen CDN nodig) --- */
    :root{
      --bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--card:#ffffff;--border:#e2e8f0;--shadow:0 1px 2px rgba(0,0,0,.04),0 4px 16px rgba(0,0,0,.05);
      --accent:#4f46e5;--good:#10b981;--warn:#f59e0b;--dark:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--fg);}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);font-size:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .input,.btn,.select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn:hover{filter:brightness(.98)}
    main{padding:24px 0}
    #alert{border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:10px;padding:10px 12px}
    #grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
    .media{position:relative;background:#f1f5f9;padding-top:75%}
    .media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;left:10px;top:10px;border-radius:999px;padding:4px 9px;font-size:12px;font-weight:600}
    .b-available{background:#d1fae5;color:#065f46}
    .b-under{background:#ffedd5;color:#92400e}
    .b-sold{background:#0f172a;color:#fff}
    .body{padding:12px 14px}
    .title{margin:0;font-size:16px;font-weight:700}
    .addr{margin:6px 0 0;color:var(--muted);font-size:13px}
    .meta{margin:6px 0 0;color:#475569;font-size:12px}
    .actions{display:flex;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
    .actions .btn{flex:0 0 auto}

    dialog{border:none;border-radius:14px;box-shadow:var(--shadow);width:min(900px,92vw)}
    dialog::backdrop{background:rgba(30,41,59,.45)}
    .modal-body{display:grid;grid-template-columns:1fr;gap:0}
    @media(min-width:900px){.modal-body{grid-template-columns:1fr 1fr}}
    .modal-media{background:#f1f5f9}
    .modal-media img{width:100%;height:100%;object-fit:cover;max-height:60vh}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin:8px 0}
    .tab{padding:8px 10px;border-bottom:2px solid transparent;font-size:14px;color:#475569}
    .tab.active{color:var(--accent);border-color:var(--accent)}
    .prose{font-size:14px;line-height:1.5}
    .prose table{border-collapse:collapse;width:100%}
    .prose th,.prose td{border:1px solid var(--border);padding:6px 8px;text-align:left}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Objecten</h1>
      <div class="muted">Lokaal te openen .html met drie laadopties: Feed‑URL, JSON plakken, JSON upload. Valt terug op voorbeelddata.</div>
      <div class="controls">
        <input id="feed-url" class="input" type="url" placeholder="https://venapp.accept.paqt.io/feed" />
        <button id="btn-load" class="btn primary">Laden</button>
        <button id="btn-paste" class="btn">Plak JSON</button>
        <label class="btn" style="cursor:pointer">Upload JSON<input id="file-input" type="file" accept="application/json,.json" style="display:none"></label>
      </div>
      <div class="controls">
        <input id="q" class="input" type="text" placeholder="Zoek op naam, adres of makelaar…" style="min-width:260px">
        <select id="city" class="select"><option value="">Alle plaatsen</option></select>
        <select id="status" class="select">
          <option value="">Alle status</option>
          <option value="available">Available</option>
          <option value="under_bid">Under bid</option>
          <option value="sold">Sold</option>
        </select>
        <select id="realtor" class="select"><option value="">Alle makelaars</option></select>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="stats" class="muted"></div>
    <div id="alert" class="hidden"></div>
    <div id="grid"></div>

    <details class="card" style="margin-top:18px;padding:12px 14px">
      <summary style="cursor:pointer;font-weight:600">Diagnose & tests</summary>
      <div id="env" class="muted" style="margin-top:8px"></div>
      <div style="margin-top:10px"><button id="btn-run-tests" class="btn">Run tests</button></div>
      <pre id="test-log" style="margin-top:10px;background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
    </details>
  </main>

  <!-- Modaal: details -->
  <dialog id="dlg">
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center">
      <div style="flex:1 1 auto">
        <div id="m-title" style="font-weight:700"></div>
        <div id="m-addr" class="muted" style="font-size:13px"></div>
      </div>
      <button id="m-close" class="btn">Sluiten</button>
    </div>
    <div class="modal-body">
      <div class="modal-media"><img id="m-img" alt="" loading="lazy"></div>
      <div style="padding:12px 14px">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <span id="m-badge" class="badge b-available" style="position:static"></span>
          <span id="m-realtor" class="muted" style="font-size:12px"></span>
          <a id="m-url" target="_blank" rel="noopener" class="btn" style="margin-left:auto">Ga naar listing</a>
        </div>
        <div id="tabs" class="tabs"></div>
        <div id="panels" class="prose"></div>
      </div>
    </div>
  </dialog>

  <!-- Modaal: JSON plakken -->
  <dialog id="paste">
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center">
      <div style="font-weight:700">Plak JSON-feed</div>
      <button id="p-close" class="btn" style="margin-left:auto">Sluiten</button>
    </div>
    <div style="padding:12px 14px">
      <textarea id="p-area" style="width:100%;height:260px;border:1px solid var(--border);border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px"></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="p-apply" class="btn primary">Toepassen</button></div>
    </div>
  </dialog>

  <script>
  (function(){
    'use strict';

    // ---------- Config & placeholders ----------
    const DEFAULT_FEED_URL = 'https://venapp.accept.paqt.io/feed';
    const PLACEHOLDER_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="400" height="300" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="16" fill="#64748b">Geen afbeelding</text></svg>`);
    const SAMPLE_FEED = [
      { url:'#1', name:'Domtoren', full_address:'Domplein 1, 3501 AA Utrecht', image:PLACEHOLDER_IMG, realtor:'Commercial Property NL', is_sold:false, availability:'available', visibility:'public', description:'<p>De Domtoren, icoon van Utrecht.</p>' },
      { url:'#2', name:'Coenenspark', full_address:'Coenensparkweg 21-25, 3552GR Zutphen', image:PLACEHOLDER_IMG, realtor:'Realtor A', is_sold:false, availability:'under_bid', visibility:'public', description:'<p>Complex met herontwikkelingspotentie.</p>' },
      { url:'#3', name:'Overblaak 570', full_address:'Test 23, 3333DD Rotterdam', image:PLACEHOLDER_IMG, realtor:'Realtor B', is_sold:true, availability:'sold', visibility:'public', description:'<p>Voorbeeld Rotterdam.</p>' },
      { url:'#4', name:'Stadhuisplein', full_address:'Stadhuisplein 10, 5611 EM Eindhoven', image:PLACEHOLDER_IMG, realtor:'Realtor C', is_sold:false, availability:'available', visibility:'public', description:'<p>Voorbeeld Eindhoven.</p>' },
      { url:'#5', name:'Centraal Station', full_address:'Stationsplein 1, 1012 AB Amsterdam', image:PLACEHOLDER_IMG, realtor:'Realtor D', is_sold:false, availability:'available', visibility:'public', description:'<p>Voorbeeld Amsterdam.</p>' }
    ];

    // ---------- Elements ----------
    const $grid = document.getElementById('grid');
    const $stats = document.getElementById('stats');
    const $alert = document.getElementById('alert');
    const $q = document.getElementById('q');
    const $city = document.getElementById('city');
    const $status = document.getElementById('status');
    const $realtor = document.getElementById('realtor');

    const $feedUrl = document.getElementById('feed-url');
    const $btnLoad = document.getElementById('btn-load');
    const $btnPaste = document.getElementById('btn-paste');
    const $fileInput = document.getElementById('file-input');

    const $env = document.getElementById('env');
    const $btnTests = document.getElementById('btn-run-tests');
    const $testLog = document.getElementById('test-log');

    const $dlg = document.getElementById('dlg');
    const $mClose = document.getElementById('m-close');
    const $mTitle = document.getElementById('m-title');
    const $mAddr = document.getElementById('m-addr');
    const $mImg = document.getElementById('m-img');
    const $mBadge = document.getElementById('m-badge');
    const $mRealtor = document.getElementById('m-realtor');
    const $mUrl = document.getElementById('m-url');
    const $tabs = document.getElementById('tabs');
    const $panels = document.getElementById('panels');

    const $paste = document.getElementById('paste');
    const $pClose = document.getElementById('p-close');
    const $pApply = document.getElementById('p-apply');
    const $pArea = document.getElementById('p-area');

    // ---------- State ----------
    let data = [];

    // ---------- Utils ----------
    function showError(html){ $alert.innerHTML = html; $alert.classList.remove('hidden'); }
    function clearError(){ $alert.classList.add('hidden'); $alert.textContent=''; }
    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]||c)); }
    function decodeHtmlEntities(str){ if (!str) return ''; const t=document.createElement('textarea'); t.innerHTML=str; return t.value; }
    function sanitizeHtml(dirty){
      if (!dirty) return '';
      const allowed = new Set(['p','strong','em','u','a','h1','h2','h3','h4','h5','h6','ul','ol','li','br','table','thead','tbody','tfoot','tr','th','td']);
      const allowedAttrs = { a:new Set(['href','target','rel']), th:new Set(['colspan','rowspan','colwidth']), td:new Set(['colspan','rowspan','colwidth']) };
      const doc = new DOMParser().parseFromString(String(dirty).replace(/<\/(script)>/gi,'&lt;/$1&gt;'),'text/html');
      (function walk(n){
        if (n.nodeType===1){
          const tag=n.tagName.toLowerCase();
          if (!allowed.has(tag)) { const p=n.parentNode; if (p){ while(n.firstChild) p.insertBefore(n.firstChild,n); p.removeChild(n);} return; }
          [...n.attributes].forEach(a=>{ const k=a.name.toLowerCase(); if (k.startsWith('on')) n.removeAttribute(a.name); else if (allowedAttrs[tag]&&!allowedAttrs[tag].has(k)) n.removeAttribute(a.name); else if(!allowedAttrs[tag]&&k!=='href'&&k!=='target'&&k!=='rel') n.removeAttribute(a.name); });
          if (tag==='a'){ const href=n.getAttribute('href')||'#'; n.setAttribute('href',href); n.setAttribute('target','_blank'); n.setAttribute('rel','noopener noreferrer nofollow'); }
        }
        [...n.childNodes].forEach(walk);
      })(doc.body);
      return doc.body.innerHTML.replace(/<p>\s*<\/p>/g,'').trim();
    }
    function getCityFromAddress(addr){ if (!addr) return ''; const parts=addr.split(',').map(s=>s.trim()); if (parts.length===1) return ''; const tail=parts[parts.length-1]; const m=tail.match(/([0-9]{4}\s?[A-Z]{2})\s+(.+)/); return m?m[2].trim():tail.trim(); }
    function statusLabel(av, sold){ if (sold||av==='sold') return {text:'Sold', cls:'b-sold'}; if (av==='under_bid') return {text:'Under bid', cls:'b-under'}; return {text:'Available', cls:'b-available'}; }

    // ---------- Fetch JSON (werkt ook lokaal; bij CORS-fout -> fallback) ----------
    async function fetchJson(url){
      const res = await fetch(url, {cache:'no-store',mode:'cors',credentials:'omit'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const ct = res.headers.get('content-type')||'';
      if (!ct.includes('application/json')) { try { return await res.json(); } catch { throw new Error('Onverwachte content-type: '+ct); } }
      return await res.json();
    }
    async function loadFeed(url){
      try{
        const json = await fetchJson(url);
        if (!Array.isArray(json)) throw new Error('Feed is geen array');
        return json.filter(x => (x.visibility||'public')==='public');
      }catch(e){
        showError('<p><strong>Kon feed niet laden</strong>: '+escapeHtml(e.message)+'</p><p>Tip: open dit bestand via http://localhost i.p.v. file:// of gebruik de knoppen “Plak JSON” of “Upload JSON”. Fallback-voorbeelddata is geladen.</p>');
        return SAMPLE_FEED;
      }
    }

    // ---------- Render ----------
    function initFilters(){
      const cities=[...new Set(data.map(x=>x._city).filter(Boolean))].sort();
      const realtors=[...new Set(data.map(x=>x.realtor).filter(Boolean))].sort();
      $city.innerHTML='<option value="">Alle plaatsen</option>' + cities.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
      $realtor.innerHTML='<option value="">Alle makelaars</option>' + realtors.map(r=>`<option>${escapeHtml(r)}</option>`).join('');
    }
    function applyFilters(){
      const qv = ($q.value||'').toLowerCase();
      const cv = $city.value||''; const sv=$status.value||''; const rv=$realtor.value||'';
      const items = data.filter(x=>{
        const hay=[x.name,x.full_address,x.realtor,x._city].join(' ').toLowerCase();
        if (qv && !hay.includes(qv)) return false;
        if (cv && x._city!==cv) return false;
        if (rv && x.realtor!==rv) return false;
        if (sv && x.availability!==sv && !(sv==='sold' && x.is_sold)) return false;
        return true;
      }).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      render(items); $stats.textContent = `${items.length} van ${data.length} objecten weergegeven`;
    }
    [$q,$city,$status,$realtor].forEach(el=>el.addEventListener('input',applyFilters));

    function render(items){
      $grid.innerHTML='';
      items.forEach(it=>{
        const card=document.createElement('div'); card.className='card';
        const media=document.createElement('div'); media.className='media';
        const img=document.createElement('img'); img.alt=it.name||''; img.src=it.image||PLACEHOLDER_IMG; img.loading='lazy'; img.onerror=()=>{img.src=PLACEHOLDER_IMG}; media.appendChild(img);
        const st=statusLabel(it.availability,it.is_sold); const badge=document.createElement('span'); badge.className='badge '+st.cls; badge.textContent=st.text; media.appendChild(badge);
        const body=document.createElement('div'); body.className='body';
        const h=document.createElement('h3'); h.className='title'; h.textContent=it.name||'—';
        const a=document.createElement('p'); a.className='addr'; a.textContent=it.full_address||'';
        const m=document.createElement('p'); m.className='meta'; m.textContent='Makelaar: '+(it.realtor||'—');
        body.appendChild(h); body.appendChild(a); body.appendChild(m);
        const act=document.createElement('div'); act.className='actions';
        const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Details'; b1.onclick=()=>openModal(it);
        const b2=document.createElement('a'); b2.className='btn'; b2.textContent='Ga naar listing'; b2.href=it.url||'#'; b2.target='_blank'; b2.rel='noopener';
        act.appendChild(b1); act.appendChild(b2);
        card.appendChild(media); card.appendChild(body); card.appendChild(act);
        $grid.appendChild(card);
      });
    }

    function openModal(item){
      $mTitle.textContent=item.name||''; $mAddr.textContent=item.full_address||'';
      $mImg.src=item.image||PLACEHOLDER_IMG; $mImg.onerror=()=>{$mImg.src=PLACEHOLDER_IMG};
      const st=statusLabel(item.availability,item.is_sold); $mBadge.textContent=st.text; $mBadge.className='badge '+st.cls; $mRealtor.textContent=item.realtor?('Makelaar: '+item.realtor):''; $mUrl.href=item.url||'#';
      const sections=[{k:'_desc',t:'Omschrijving'},{k:'_loc',t:'Locatie'},{k:'_spec',t:'Specificaties'},{k:'_proc',t:'Verkoopprocedure'}].filter(s=>item[s.k]&&item[s.k].trim());
      $tabs.innerHTML=''; $panels.innerHTML='';
      if (!sections.length){ $tabs.innerHTML='<span class="muted">Geen aanvullende informatie.</span>'; }
      else{
        sections.forEach((s,i)=>{
          const btn=document.createElement('button'); btn.className='tab'+(i? '':' active'); btn.textContent=s.t; btn.onclick=()=>activateTab(s.k,sections,item); $tabs.appendChild(btn);
        });
        activateTab(sections[0].k,sections,item);
      }
      $dlg.showModal();
    }
    function activateTab(key,sections,item){
      [...$tabs.children].forEach(ch=>ch.classList.toggle('active', ch.textContent===sections.find(s=>s.k===key).t));
      $panels.innerHTML=item[key]||'';
    }
    $mClose.addEventListener('click',()=>{$dlg.close()});

    // ---------- Data voorbereiding ----------
    function prepare(raw){
      data=(raw||[]).map(x=>({...x}));
      data.forEach(x=>{ x._city=getCityFromAddress(x.full_address); x._desc=sanitizeHtml(decodeHtmlEntities(x.description)); x._loc=sanitizeHtml(decodeHtmlEntities(x.location)); x._spec=sanitizeHtml(decodeHtmlEntities(x.specifications)); x._proc=sanitizeHtml(decodeHtmlEntities(x.selling_procedure)); });
      initFilters(); applyFilters();
    }

    // ---------- Diagnose & tests ----------
    function renderEnv(){
      const lines=[`Origin: ${location.origin||'(file)'} | Protocol: ${location.protocol} | Online: ${navigator.onLine}`];
      $env.innerHTML=lines.join('<br>');
    }
    function assert(name,cond){ if(!cond) throw new Error(name); return '✔ '+name; }
    function log(m){ $testLog.textContent+=m+'\n'; }
    function runTests(){
      $testLog.textContent='';
      try{
        log(assert('City parse (Utrecht)', getCityFromAddress('Europalaan 40, 2512 AB Utrecht')==='Utrecht'));
        log(assert('City parse (Rotterdam)', getCityFromAddress('Test 23, 3333DD Rotterdam')==='Rotterdam'));
        log(assert('City parse (fallback)', getCityFromAddress('Zonder komma')===''));
        const dirty='<p>ok</p><script>alert(1)<\\/script><a href="https://example.com" onclick="x()">link</a>';
        const clean=sanitizeHtml(dirty);
        log(assert('Sanitizer strips <script>', !clean.includes('<script')));
        log(assert('Anchor keeps href+rel+target', clean.includes('href=')&&clean.includes('rel=')&&clean.includes('target=_blank')));
        log(assert('Sanitizer strips on*', !clean.includes('onclick')));
        const s1=statusLabel('available',false).text==='Available';
        const s2=statusLabel('under_bid',false).text==='Under bid';
        const s3=statusLabel('sold',false).text==='Sold';
        log(assert('status labels', s1&&s2&&s3));
        log('Alle tests PASS.');
      }catch(e){ log('❌ FAIL: '+e.message); }
    }

    // ---------- Events ----------
    $btnLoad.addEventListener('click', async ()=>{ const u=($feedUrl.value||'').trim(); if(!u) return; const raw=await loadFeed(u); prepare(raw); });
    $btnPaste.addEventListener('click', ()=>{ $paste.showModal(); });
    $pClose.addEventListener('click', ()=>{ $paste.close(); });
    $pApply.addEventListener('click', ()=>{ try{ const json=JSON.parse($pArea.value); if(!Array.isArray(json)) throw new Error('JSON is geen array'); clearError(); $paste.close(); prepare(json);}catch(e){ showError('Kon geplakte JSON niet lezen: '+escapeHtml(e.message)); }});
    $fileInput.addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; try{ const text=await f.text(); const json=JSON.parse(text); if(!Array.isArray(json)) throw new Error('JSON-bestand bevat geen array'); clearError(); prepare(json);}catch(err){ showError('Kon JSON-bestand niet lezen: '+escapeHtml(err.message)); } finally{ e.target.value=''; }});
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if($paste.open) $paste.close(); if($dlg.open) $dlg.close(); }});
    $btnTests.addEventListener('click', runTests);

    // ---------- Bootstrap ----------
    (async function(){
      renderEnv();
      // URL-parameter ?feed= ondersteunt snel testen vanaf lokaal bestand
      const alt = (new URLSearchParams(location.search)).get('feed');
      $feedUrl.value = alt || DEFAULT_FEED_URL;
      const raw = await loadFeed($feedUrl.value);
      prepare(raw);
    })();
  })();
  </script>
</body>
</html>
